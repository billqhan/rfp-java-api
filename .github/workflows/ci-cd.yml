name: CI/CD Pipeline (EKS - DISABLED)

# EKS workflow disabled - using ECS deployment (ci-cd-ecs.yml)
# To re-enable: uncomment the 'on:' section below
on:
    # Production EKS deployment disabled (pipeline globally disabled)
    if: false
    runs-on: ubuntu-latest
    steps:
      - name: Skip production EKS deployment
        run: echo "Production EKS deployment disabled"
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Run unit tests
        run: mvn test

      - name: Run integration tests
        run: mvn verify -DskipUnitTests || echo "Integration tests not configured"

      - name: Generate test coverage report
        run: mvn jacoco:report || echo "Coverage not configured"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: target/surefire-reports/
          retention-days: 7

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar
          retention-days: 7

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        if: github.event_name == 'push'
        uses: aws-actions/amazon-ecr-login@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.ECR_REGISTRY }}/rfp-java-api
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          name: CI/CD Pipeline (EKS - DISABLED)

          # EKS workflow disabled - using ECS deployment (ci-cd-ecs.yml)
          # To re-enable: uncomment the push/pull_request triggers
          on:
            workflow_dispatch:

          env:
            JAVA_VERSION: '17'
            MAVEN_VERSION: '3.9'

          jobs:
            validate-contracts:
              name: Validate API Contracts
              runs-on: ubuntu-latest
              steps:
                - name: Checkout code
                  uses: actions/checkout@v4
                  with:
                    submodules: recursive
                - name: Validate contracts
                  run: |
                    chmod +x validate-contracts.sh
                    ./validate-contracts.sh

            build-and-test:
              name: Build and Test
              runs-on: ubuntu-latest
              needs: validate-contracts
              steps:
                - name: Checkout code
                  uses: actions/checkout@v4
                  with:
                    submodules: recursive
                - name: Setup Java
                  uses: actions/setup-java@v4
                  with:
                    java-version: ${{ env.JAVA_VERSION }}
                    distribution: 'temurin'
                    cache: 'maven'
                - name: Build with Maven
                  run: mvn clean package -DskipTests
                - name: Run unit tests
                  run: mvn test
                - name: Run integration tests
                  run: mvn verify -DskipUnitTests || echo "Integration tests not configured"
                - name: Generate test coverage report
                  run: mvn jacoco:report || echo "Coverage not configured"
                - name: Upload test results
                  if: always()
                  uses: actions/upload-artifact@v4
                  with:
                    name: test-results
                    path: target/surefire-reports/
                    retention-days: 7
                - name: Upload JAR artifact
                  uses: actions/upload-artifact@v4
                  with:
                    name: application-jar
                    path: target/*.jar
                    retention-days: 7

            build-docker:
              name: Build Docker Image
              runs-on: ubuntu-latest
              needs: build-and-test
              steps:
                - name: Checkout code
                  uses: actions/checkout@v4
                - name: Download JAR artifact
                  uses: actions/download-artifact@v4
                  with:
                    name: application-jar
                    path: target/
                - name: Set up Docker Buildx
                  uses: docker/setup-buildx-action@v3
                - name: Login to Amazon ECR
                  if: github.event_name == 'push'
                  uses: aws-actions/amazon-ecr-login@v2
                - name: Extract metadata
                  id: meta
                  uses: docker/metadata-action@v5
                  with:
                    images: ${{ secrets.ECR_REGISTRY }}/rfp-java-api
                    tags: |
                      type=ref,event=branch
                      type=sha,prefix={{branch}}-
                      type=semver,pattern={{version}}
                      type=raw,value=latest,enable={{is_default_branch}}
                - name: Build and push Docker image
                  uses: docker/build-push-action@v5
                  with:
                    context: .
                    push: ${{ github.event_name == 'push' }}
                    tags: ${{ steps.meta.outputs.tags }}
                    labels: ${{ steps.meta.outputs.labels }}
                    cache-from: type=gha
                    cache-to: type=gha,mode=max
                    platforms: linux/amd64,linux/arm64

            deploy-prod:
              # Production EKS deployment explicitly disabled
              if: false
              runs-on: ubuntu-latest
              steps:
                - name: Skip production EKS deployment
                  run: echo "Production EKS deployment disabled"

